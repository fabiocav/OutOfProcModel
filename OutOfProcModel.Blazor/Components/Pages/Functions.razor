@page "/functions"
@using Grpc.Core
@using Grpc.Net.Client
@using OutOfProcModel.Abstractions.ControlPlane
@using OutOfProcModel.FunctionsHost.Grpc
@using ProtoBuf.Grpc.Client
@using System.Collections.Concurrent
@using System.Threading.Channels
@using System.Text.Json
@using System.Diagnostics
@rendermode InteractiveServer
@inject ILogger<Functions> Logger
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Config

<PageTitle>Functions</PageTitle>
<h3>Functions1</h3>

<div class="d-flex" style="width:100%;height:275px">
    <div class="mb-3" style="max-width: 25%">
        <div class="card card-header">WorkerController</div>
        <div class="card card-body font-monospace">
            <div class="d-flex align-items-center mb-2">
                <label for="runtimeInput" class="form-label mb-0 me-2">Runtime</label>
                <input id="runtimeInput" class="form-control" @bind="_runtime" />
            </div>
            <div class="d-flex align-items-center mb-2">
                <label for="versionInput" class="form-label mb-0 me-2">Version</label>
                <input id="versionInput" class="form-control" @bind="_version" />
            </div>
            <div class="d-flex align-items-center mb-2">
                <label for="archInput" class="form-label mb-0 me-2">Architecture</label>
                <input id="archInput" class="form-control" @bind="_arch" />
            </div>
            <div class="d-flex align-items-center mb-2">
                <label for="placeholderCheckbox" class="form-check-label mb-0">Placeholder?</label>
                <input id="placeholderCheckbox" type="checkbox" class="form-check-input me-2" @bind="_isPlaceholder" />
            </div>
            <button class="btn btn-primary mb-1" @onclick="AddWorkerAsync">Add Worker</button>
        </div>
    </div>

    <div class="mb-3" style="max-width: 25%">
        <div class="card card-header">Specializer</div>
        <div class="card card-body font-monospace">
            <div class="d-flex align-items-center mb-2">
                <label for="runtimeInputSpecialize" class="form-label mb-0 me-2">Runtime</label>
                <input id="runtimeInputSpecialize" class="form-control" @bind="_runtimeSpecialize" />
            </div>
            <div class="d-flex align-items-center mb-2">
                <label for="versionInputSpecialize" class="form-label mb-0 me-2">Version</label>
                <input id="versionInputSpecialize" class="form-control" @bind="_version" />
            </div>
            <div class="d-flex align-items-center mb-2">
                <label for="archInputSpecialize" class="form-label mb-0 me-2">Architecture</label>
                <input id="archInputSpecialize" class="form-control" @bind="_archSpecialize" />
            </div>           
            <button class="btn btn-primary mb-1" @onclick="SpecializeWorkerAsync">Specialize</button>
        </div>
    </div>

    <div class="mb-3" style="width:50%;height:100%">
        <div class="card card-header">Invoker</div>
        <div class="card card-body font-monospace">
            <button class="btn btn-primary" @onclick="InvokeAsync">Invoke</button>
            <textarea class="form-control mt-2" rows="6" readonly style="resize: none;">@_invokeResults</textarea>
        </div>
    </div>
</div>

<div class="mt-3">
    <div class="card card-header">Host status</div>
    <div class="card card-body font-monospace">
        @_statusResult
    </div>
</div>
<div class="mt-3">
    <div class="card card-header">WorkerController status</div>
    <div class="card card-body font-monospace">
        @_controllerStatusResult
    </div>
</div>

@code {
    private string _runtime = "dotnet-isolated";
    private string _version = "9.0";
    private string _arch = "x64";
    private bool _isPlaceholder = false;
    private string _invokeResults = string.Empty;

    private string _runtimeSpecialize = "dotnet-isolated";
    private string _versionSpecialize = "9.0";
    private string _archSpecialize = "x64";

    protected override Task OnInitializedAsync()
    {
        _functionsAdminService ??= CreateFunctionsAdminGrpcService(Config);
        _workerControllerClient = HttpClientFactory.CreateClient("workercontroller");

        _ = StartStatusPollAsync();
        return Task.CompletedTask;
    }

    // map workerId -> channelToFunctionsHost
    private static ConcurrentDictionary<string, Channel<FunctionsGrpcMessage>> _workerChannels = new();

    private static IFunctionsAdminGrpcService? _functionsAdminService;
    private static HttpClient _workerControllerClient;

    private MarkupString? _statusResult = null;
    private MarkupString? _controllerStatusResult = null;

    private static string _applicationId = "a_" + Guid.NewGuid().ToString()[..8]; // only operate on one app for now
    private static string _placeholderId = "ph_" + Guid.NewGuid().ToString()[..8];

    private async Task AddWorkerAsync()
    {
        // Tell the WorkerController to add a worker
        _ = await _workerControllerClient.PostAsJsonAsync("/addworker",
        new
        {
            applicationContext = new
            {
                ApplicationId = _isPlaceholder ? _placeholderId : _applicationId,
                ApplicationVersion = _isPlaceholder ? "0.0.0.0" : "1.0.0"
            },
            runtimeEnvironment = new
            {
                Runtime = _runtime,
                Version = _version,
                Architecture = _arch,
                IsPlaceholder = _isPlaceholder
            }
        });
    }

    private static IFunctionsAdminGrpcService CreateFunctionsAdminGrpcService(IConfiguration config)
    {
        var hostUriPath = ConfigurationPath.Combine("services", "functionsHost", "http", "0");
        var address = config[hostUriPath];

        GrpcClientFactory.AllowUnencryptedHttp2 = true;
        var http = GrpcChannel.ForAddress(address);
        return http.CreateGrpcService<IFunctionsAdminGrpcService>();
    }

    public async Task StartStatusPollAsync()
    {
        while (true)
        {
            await Task.Delay(1000);
            _functionsAdminService ??= CreateFunctionsAdminGrpcService(Config);
            var state = await _functionsAdminService.GetStateAsync();

            state = state.Replace("\r\n", "<br/>");
            state = state.Replace(" ", "&nbsp;");

            _statusResult = (MarkupString)state;

            var result = await _workerControllerClient.GetAsync("/status");
            var controllerStatus = await result.Content.ReadAsStringAsync();
            controllerStatus = JsonSerializer.Deserialize<string>(controllerStatus)!;
            controllerStatus = controllerStatus.Replace("\r\n", "<br/>");
            controllerStatus = controllerStatus.Replace(" ", "&nbsp;");

            _controllerStatusResult = (MarkupString)(controllerStatus);
            StateHasChanged();
        }
    }

    public async Task InvokeAsync()
    {
        _functionsAdminService ??= CreateFunctionsAdminGrpcService(Config);

        Stopwatch sw = Stopwatch.StartNew();
        var result = await _functionsAdminService.InvokeAsync(new InvokeContext
        {
            ApplicationId = _applicationId,
            TriggerId = "HttpTrigger1",
            Data = "random_data"
        });
        var duration = sw.ElapsedMilliseconds;

        var line = $"[{DateTime.UtcNow.ToString("HH:mm:ss.ff")}] {result.InvocationId} | {result.WorkerId} | {result.Result} | {duration}ms";

        _invokeResults = line + Environment.NewLine + _invokeResults;
    }

    public async Task SpecializeWorkerAsync()
    {
        _functionsAdminService ??= CreateFunctionsAdminGrpcService(Config);

        // Tell the WorkerController to specialize a worker
        var appContext = new ApplicationContext(_applicationId, "1.0.0");

        // TODO: fix this... needs to be placeholder for matching right now
        var runtimeEnvironment = new RuntimeEnvironment(_runtimeSpecialize, _versionSpecialize, _archSpecialize, isPlaceholder: true);

        // TODO: think through races here?
        var result = await _workerControllerClient.GetAsync("/status");
        var controllerStatus = await result.Content.ReadAsStringAsync();
        controllerStatus = JsonSerializer.Deserialize<string>(controllerStatus)!;

        await _functionsAdminService.SpecializeApplicationAsync(new() { ApplicationContext = appContext, RuntimeEnvironment = runtimeEnvironment });
    }
}
